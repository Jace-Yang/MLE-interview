

# 进程与调度 & 线程

## 1. 进程的概念

**定义：**


![img](https://pic3.zhimg.com/80/v2-82f87a0b5b480e2a1394466e36f2f4b5_1440w.jpeg)


程序是静态的，进程是动态的。进程 = 程序+执行状态。进程有核心态、用户态。

##### 1.1 进程的组成：

进程包含了正在运行的程序的所有状态信息。

- 代码
- 数据
- 状态寄存器（敏感寄存器，如指令指针IP）
- 32个通用寄存器
- 进程占用系统资源（打开文件、已分配内存...）

进程的特点：

- 动态性：可动态创建/结束进程
- 并发性：进程可以被独立调度并占用处理机运行（宏观上并发执行，微观上交替执行）
- 独立性：不同进程工作不互相影响
- 制约性：因访问共享数据、资源或进程间同步而产生制约

### 2. 进程控制块

进程对应的唯一标识。

![img](https://pic3.zhimg.com/80/v2-6f6909c1049a3f432409448ca44b55fc_1440w.jpeg)



### 3. 进程状态

进程的生命周期划分

- 创建
- 执行：内核选一个就绪的进程，让它占用处理机执行。如何选择呢？这就要涉及调度算法了。
- 等待：当条件不满足，比如等待数据/资源不够。自己进入等待状态。
- 抢占：高优先级进程就绪，直接开始运行。或者，进程执行当前时间片用完。
- 唤醒：阻塞进程需要的资源可以被满足，等待的事件到达。只能由其他进程/操作系统来唤醒。
- 结束



三状态进程模型：

- 运行状态
- 就绪状态：进程获得除处理机外所有资源，得到处理机即可运行；
- 等待状态：因等待某一事件而暂停运行

挂起进程模型：

之前的三状态进程模型，是和CPU相关的；“进程挂起”是和存储相关的。处在挂起状态的进程映像在磁盘上，目的是减少进程占用内存。“挂起”状态就是指**进程在外存中**的状态。



### 4. 处理机调度

#### 4.1 先来先服务

按进程进入**就绪状态**的先后顺序排列。这样短进程有可能排在长进程后面，导致资源浪费（平均等待时间不稳定，最坏情况有可能特别长）。

#### 4.2 时间片轮转

交替执行
![img](https://pic1.zhimg.com/80/v2-cd184b642bfee120ba5fc7ca2401092b_1440w.jpeg)




平均等待时间更加稳定。缺点是产生额外的上下文切换。



### 5. 进程控制

##### 5.1 进程切换

全靠进程控制块(PCB)来保存/恢复进程状态。
![img](https://pic2.zhimg.com/80/v2-5c236bd3f8284d66e1fbc7c07c9df569_1440w.jpeg)



![img](https://pic3.zhimg.com/80/v2-31c3b54f30308f62eaae933342131448_1440w.jpeg)




##### 5.2 进程创建

fork() 创建一个继承的子进程，复制父进程的所有变量和内存、寄存器。

子进程的fork()返回0，父进程fork()返回子进程标识符。

![img](https://pic1.zhimg.com/80/v2-81e3242922e51f7c69dcede10b3bede9_1440w.jpeg)



99%的情况，子进程在fork()之后立刻调用exec(), 加载新的程序覆盖掉代码块：



![img](https://pica.zhimg.com/80/v2-fad6d95c6a370a11094c894479db4abc_1440w.jpeg)

那么，fork()中的那么多内存复制操作其实是浪费的。所以，可以把fork()+exec()结合在一个调用中，现在使用的都是Copy on Write操作。



##### 5.3 进程等待和退出

父进程先wait(), 待子进程exit()之后唤醒父进程。

##### 5.4 优先级控制

每个进程可以指定优先级。Unix系统中，进程优先级会随着执行时间而衰减。



## 6. 线程

为什么要引入线程呢？这是因为，一个进程内部，我们往往希望其具有并发性。所以，在进程内部增加一类实体，满足：

- 实体之间可以并发执行；
- 实体之间共享相同的地址空间，这样信息交流方便，不用隔离。

这样的实体就是线程。

【定义】线程是进程中**指令执行流**的基本单元，是**CPU调度**的基本单位。

![6648cd135f47647fc9b9d20616f4178](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\6648cd135f47647fc9b9d20616f4178.jpg)

【线程与进程比较】（常考！）

- 进程是资源分配的基本单位（代码+数据+打开文件），线程是CPU调度的基本单位，描述指令流执行状态（寄存器+堆栈）
- 进程拥有一个完整的资源平台，而线程只独享指令流执行的必要资源，如寄存器和栈。
- 线程的创建、结束、切换时间都比线程短
- 由于同一进程的各个线程共享内存和文件资源，可不通过内核直接通信。

【线程的三种实现方式】

- 用户线程：内核不了解用户线程的存在，因此可用于不支持线程的多进程操作系统；每个进程有私有的线程控制块(TCB)列表，每个进程有自己的线程调度算法；同一进程内的用户线程不需要用户态、核心态切换。

![9787f3d502c8cf7a97f32be9a86e333](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\9787f3d502c8cf7a97f32be9a86e333.jpg)

- 内核线程：由内核通过系统调用来完成线程的创建、终止、管理。

![427ecbdf2adbed7eb25a6a5fe5901fe](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\427ecbdf2adbed7eb25a6a5fe5901fe.jpg)







【面试题：同步/异步；阻塞/非阻塞的区别是什么？】





