# 同步互斥

并发进程在多个进程间有资源共享，因此执行过程是不确定的、不可重现的。程序错误是间歇性发生的。

【原子操作】

要么操作成功完成、要么就没有发生。操作系统需要利用同步机制在并发执行的同时，保证一些操作是原子操作。

【锁】

锁是一个抽象的数据结构，是一个**二进制**变量，只有一个进程能获得锁。在锁被释放之前，其他进程一直等待；释放锁之后，唤醒等待的进程。

```c++
lock.acquire(); //进入临界区
... //原子操作,临界区
lock.release(); //退出临界区
```

临界区的访问规则：

- 空闲则入：没有进程在临界区，任何进程可进入
- 忙则等待：有进程在临界区时，其他进程均不能进入临界区。
- 有限等待：等待进入临界区的进程不能无限制等待（饥饿）

【死锁现象】：多个进程各**占用部分资源，同时请求其他资源**，形成循环等待。

出现死锁的**必要条件**：

- 互斥。只有一个进程能使用一个资源实例。
- 持有并等待。进程保持至少一个资源，并正在等待其他进程持有的资源。
- 非抢占。资源只能在进程使用后自愿释放。
- 循环等待。P0在等待P1占用的资源，...$P_{N-1}$在等待PN占用的资源，PN在等待P0占用的资源。

这个不是充分条件，例如下图右侧虽然有循环等待，但是没有锁死。

![758883fb3127d68171a07259d295ecf](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\758883fb3127d68171a07259d295ecf.jpg)



【饥饿现象】：其他进程可能轮流占用资源，一个进程一直得不到资源。

【信号量】：信号量是和锁同一级别的数据结构。是操作系统提供的一种协调共享资源访问的方法（OS是管理者）。用信号量表示系统资源的数量。信号量有一个整型变量(sem)和两个原子操作组成：

- P(): 荷兰语“尝试减少”。sem减1，如sem<0 则进入等待队列，否则继续；
- V(): 荷兰语“增加”，sem加1，如sem<=0, 则唤醒一个等待进程。

![cd5aad631a311c5d2f89228c4374092](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\cd5aad631a311c5d2f89228c4374092.jpg)

【哲学家就餐问题】

5个哲学家围绕一张圆桌而坐，桌上放着5个叉子，每两个哲学家之间放一支。哲学家的动作包括思考、进餐。进餐时需要拿到左右两边的叉子；思考时把叉子放回原处。、

![1203710c8ebd22ad403f9f5808e987e](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\1203710c8ebd22ad403f9f5808e987e.jpg)

- 方案一：每把叉子对应一个信号量，值为1。这样有可能死锁（大家一起拿左边的叉子）
- 方案二：用临界区上锁，每次只能有一个人吃饭。
- 方案三：偶数编号，先拿左边的叉子；奇数编号，先去拿右边叉子。这样没有死锁，切可有多人同时就餐。

![4cfcc8968d538ca898546acaff5f49d](C:\Users\zh-wa\AppData\Local\Temp\WeChat Files\4cfcc8968d538ca898546acaff5f49d.jpg)